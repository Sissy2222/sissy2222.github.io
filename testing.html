<style>h1 {
  text-shadow: 2px 2px 4px #282828;
}
</style>
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Sylvia B Tutoring Profile</title>
    <link rel="icon" href="/images/fav.png" sizes="16x16 32x32" type="image/png">
  
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet" 
        integrity="sha384-0evHe/X+R7YkIZDRvuzKMRqM+OrBnVFBL6DOitfPri4tjfHxaWutUpFmBp4vmVor" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-1.10.2.js"></script>

	   <link href="https://fonts.googleapis.com/css2?family=Permanent+Marker&display=swap" rel="stylesheet">
    <script src="/index.js" type="module"></script>

 </head>
  <body> 
    
 <div id="nav-placeholder">
</div>

<script>
$(function(){
  $("#nav-placeholder").load("navigation.html");
});
</script> 

	  <script>
		  const Ably = require('ably/promises');

module.exports = async function (context, req) {
    const client = new Ably.Realtime(process.env.ABLY_API_KEY);
    const tokenRequestData = await client.auth.createTokenRequest({ clientId: 'ably-whiteboard' });
    context.res = { 
        headers: { "content-type": "application/json" },
        body: JSON.stringify(tokenRequestData)
    };
};
	  </script>




    <div class="frame-top"></div>
    <div class="frame-left"></div>
    <div class="frame-right"></div>
    <div class="frame-bottom"></div>	  


	    <section id="join" class="join hidden">
        <h1>Join a Whiteboard</h1>
        <form id="joinForm" class="join-form">
            <label for="boardName">Board Name: </label><input id="boardName" name="boardName" type="text" />
            <button id="joinBtn" type="submit">Join</button>
        </form>
    </section>


    <div id="activeBoard" class="hidden board-holder">
        <canvas id="draw"></canvas>
        <ul id="colours" class="colours">
            <li class="pen" id="green" data-color="green"></li>
		  <li class="pen" id="yellow" data-color="yellow"></li>
		  <li class="pen" id="orange" data-color="orange"></li>
            <li class="pen" id="blue" data-color="blue"></li>
            <li class="pen" id="red" data-color="red"></li>
            <li class="pen" id="black" data-color="black"></li>
            <li class="eraser" id="white" data-color="white"></li>
        </ul>
    </div>


<ul id="backgrounds" class="backgrounds">
    <li class="blank background" id="blank" data-bg="blank"></li>
    <li class="lined background" id="lined" data-bg="lined"></li>
    <li class="squared background" id="squared" data-bg="squared"></li>
    <li class="dotted background" id="dotted" data-bg="dotted"></li>
    <li class="graph background" id="graph" data-bg="graph"></li>
</ul>
	  


	  
	
<script>




	
	
import { DrawableCanvasElement } from "@snakemode/snake-canvas";
import Ably from 'ably/promises';

async function updateActiveCount(channel) {
    const members = await channel.presence.get();
    document.getElementById("memberCount").innerHTML = members.length;
}

async function joinBoard(boardId) {
    const canvas = new DrawableCanvasElement("draw");
    canvas.setSize(1024, 720);
    canvas.registerPaletteElements("paletteId");

    const ably = new Ably.Realtime.Promise({ authUrl: '/api/createTokenRequest' });
    const channel = ably.channels.get(`whiteboard-${boardId}`);

    await channel.subscribe((message) => {
        if (message.name === "setBackground") {
            canvas.paintCanvas.setAttribute('data-background', message.data);
            return;
        }

        if (ably.connection.id != message.connectionId) {
            canvas.addMarks(message.data);
        }
    });

    canvas.onNotification((evt) => {
        channel.publish({ name: "drawing", data: evt });
    });

    channel.presence.subscribe('enter', async () => { updateActiveCount(channel); });
    channel.presence.subscribe('leave', async () => { updateActiveCount(channel); });
    channel.presence.enter();

    return { canvas, channel };
};

(async function () {
    const urlParams = new URLSearchParams(location.search);
    const boardName = urlParams.get("boardName");

    if (!boardName) {
        document.getElementById("boardName").value = "1234";
        document.getElementById("join").classList.remove("hidden");
        return;
    }

    const state = await joinBoard(boardName);
    document.getElementById("activeBoard").classList.remove("hidden");

    const backgrounds = document.getElementById("backgrounds");
    for (let bg of backgrounds.children) {
        bg.addEventListener('click', (event) => {
            state.channel.publish({ name: "setBackground", data: event.target.dataset["bg"] });
        });
    }
})();
</script>
	


	  

  </body>	
      
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0-beta1/dist/js/bootstrap.bundle.min.js" 
         integrity="sha384-pprn3073KE6tl6bjs2QrFaJGz5/SUsLqktiwsUTF55Jfv3qYSDhgCecCxMW52nD2" crossorigin="anonymous"></script>  
<div id="fot-placeholder"></div>
<script>
$(function(){
  $("#fot-placeholder").load("footer.html");
});
</script>
